<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />

    <title>Schmee</title>

    <link rel="shortcut icon" type="image/png" href="favicon.png">

    <link href="lib/ionic/css/ionic.css" rel="stylesheet">
    <link href="lib/ionic-material/dist/ionic.material.min.css" rel="stylesheet">

    <!-- Library Scripts -->
    <script src="lib/ionic/js/ionic.bundle.js"></script>
    <script src="lib/ionic-material/dist/ionic.material.min.js"></script>

    <script type="text/javascript" src="lib/ngCordova/dist/ng-cordova.min.js"></script>
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="lib/jquery/dist/jquery.min.js"></script>

    <!-- App Scripts -->
    <script src="js/parseEmoji.js"></script>
    <script src="js/parseEmojiTests.js"></script>
    <script src="js/contacts.js"></script>
    <script src="js/contactsTests.js"></script>
    <script src="js/app.js"></script>

    <link rel="stylesheet" href="css/base.css">
</head>
<body ng-app="schmee" onload="onLoad()">
    
    <ion-nav-bar class="bar-stable">
      <ion-nav-back-button>
      </ion-nav-back-button>
    </ion-nav-bar>
             
    <ion-nav-view></ion-nav-view>


    <script id="templates/tabs.html" type="text/ng-template">
      <ion-tabs class="tabs-icon-top tabs-striped">

        <ion-tab title="Messages" icon="ion-email" href="#/tab/home">
          <ion-nav-view name="home-tab"></ion-nav-view>
        </ion-tab>

        <ion-tab title="Contacts" icon="ion-person-stalker" ui-sref="tabs.contacts">
          <ion-nav-view name="contacts-tab"></ion-nav-view>
        </ion-tab>

        <ion-tab title="Settings" icon="ion-gear-a" ui-sref="tabs.settings">
          <ion-nav-view name="settings-tab"></ion-nav-view>
        </ion-tab>

      </ion-tabs>
    </script>

    <script id="templates/sendMessageModal.html" type="text/ng-template">
      <ion-modal-view>
        <ion-header-bar>
          <h1 class="title">Send Message</h1>
        </ion-header-bar>
        <ion-content class='padding'>
          <div class="list">
            <label class="item item-input">
              <span class="input-label">To</span>
              <input type="text" id='smsTo' ng-model="sms.to">
            </label>
            <label class="item item-input">
              <span class="input-label">Message</span>
              <textarea rows='5' autofocus id='smsBody' type="text" ng-model="sms.body"></textarea>
            </label>
          </div>

          <button class="button button-striped" ng-click="closeModal()">Cancel</button>
          <button class="button button-balanced" ng-click="sendSMS()">Send</button>
        </ion-content>
      </ion-modal-view>
    </script>

    <script id="templates/home.html" type="text/ng-template">
      <ion-view view-title="Messages">
        <ion-content class="padding">
            <!--<button class='button button-balanced ink' id='watchBtn' onclick="toggleWatch();">Start Watching SMS</button>
            <button class='button button-balanced ink' onclick="updateStatus('');updateData('');smsList.length=0;">Clear Messages</button>-->
            <div id='status'></div>
            <ion-list ng-controller="MessagesCtrl"
                      show-delete="shouldShowDelete"
                      id='data'>
                <ion-item class='item-text-wrap msg' ng-repeat="item in messages"
                            class="item-thumbnail-left">
                    <p>{{ item.body }}</p>

                    <a ng-href="sms:{{item.fromNumber}}" class='message-reply button-calm button button-clear enable-pointer-events pull-right'>Reply</a>
                    ~ {{ item.fromName }}
                    
                    <ion-delete-button class="message-delete ion-minus-circled button-positive button button-clear"
                       ng-click="messages.splice($index, 1)">
                    </ion-delete-button>
                </ion-item>
            </ion-list>
            <div id="test"></div>
        </ion-content>
      </ion-view>
    </script>

    <script id="templates/contacts.html" type="text/ng-template">
      <ion-view title="Contacts" id='contactsView'>
        <ion-content >
            <ion-list>
                <ion-item ng-repeat="contact in contacts">
                    <h2>{{contact.displayName}}</h2>

                    <ion-checkbox class='assertive' ng-model="contact.emergency"
                                  ng-checked="contact.emergency"
                                  ng-click="toggleEmergency(contact.id)">
                      Accept !emergency ‚ùó
                    </ion-checkbox>

                    <ion-checkbox class='positive' ng-model="contact.alerts"
                                  ng-checked="contact.alerts"
                                  ng-click="toggleAlert(contact.id)">
                      Accept !alert üëÇ
                    </ion-checkbox>

                    <ion-checkbox ng-model="contact.silent"
                                  ng-checked="contact.silent"
                                  ng-click="toggleSilent(contact.id)">
                      Accept !silent üò∂
                    </ion-checkbox>

                    <!--<ion-checkbox class='energized' ng-model="contact.schedule"
                                  ng-checked="contact.schedule"
                                  ng-click="toggleSchedule(contact.id)">
                      Accept !schedule
                    </ion-checkbox>-->
                </ion-item>
            </ion-list>
        </ion-content>
      </ion-view>
    </script>
    

    <script id="templates/settings.html" type="text/ng-template">
      <ion-view title="Settings" id='settingsView'>
        <ion-content>
            <ion-list>
                <ion-toggle ng-model="accept_unknown_emergency"
                            ng-checked="accept_unknown_emergency"
                            ng-click="toggleAcceptUnknownEmergency()">
                  Accept !emergency from unknown numbers
                </ion-toggle>

                <ion-toggle ng-model="accept_unknown_alert"
                            ng-checked="accept_unknown_alert"
                            ng-click="toggleAcceptUnknownAlert()">
                  Accept !alert from unknown numbers
                </ion-toggle>

                <ion-toggle ng-model="accept_unknown_silent"
                            ng-checked="accept_unknown_silent"
                            ng-click="toggleAcceptUnknownSilent()">
                  Accept !silent from unknown numbers
                </ion-toggle>
            </ion-list>
        </ion-content>
      </ion-view>
    </script>

    <script type='text/javascript'>
        var debug = true;

        var notificationID = 1;

        function onLoad() {
            if(( /(ipad|iphone|ipod|android)/i.test(navigator.userAgent) )) {
                document.addEventListener('deviceready', initApp, false);
            } else {
                updateStatus('Must be run on a mobile device for full functionality.');
                
                // Test Components
                if (debug) {
                    // parseEmoji.js and parseEmojiTests.js required
                    parseEmojiTest();
                    // contacts.js and contactsTests.js required
                    contactsTest();

                    data = testNotification;
                    schmeeNotifications(data);

                }
            }

            loadContacts();
        }
        

        scheduleEmergency = function(txt, type, from) {
            cordova.plugins.notification.local.schedule({
                id: notificationID,
                text: txt,
                title: type + " from " + from,
                icon: 'file://favicon.png',
                sound: 'file://emergency.mp3'
            });

            showToast(txt);
            notificationID = notificationID + 1;
        }

        scheduleAlert = function(txt, type, from) {
            cordova.plugins.notification.local.schedule({
                id: notificationID,
                text: txt,
                title: type + " from " + from,
                icon: 'file://favicon.png'
            });

            showToast(txt);
            notificationID = notificationID + 1;
        };

        scheduleSilent = function(txt, type, from) {
            cordova.plugins.notification.local.schedule({
                id: notificationID,
                text: txt,
                title: type + " from " + from,
                icon: 'file://favicon.png',
                sound: null
            });
            notificationID = notificationID + 1;
        };

        var default_notify = true;

        // we will store the intercepted SMS here for later restore
        var smsList = [];
        var interceptEnabled = false;
        var watching = false;

        var testNotification = {
            id: 3,
            address: '0835598888888',
            body: 'test !emergency',
            displayName: "Mocha Dick"
        }

        function schmeeNotifications(data) {
            var contacts = loadSavedContacts();
            var fromNumber = data.address;
            var msg = data.body;
            var fromName = getDisplayName(contacts, fromNumber);

            var message = {
                id: notificationID,
                address: fromNumber,
                body: msg,
                fromName: fromName
            }

            // push to MessagesCtrl scope
            var scope = angular.element($("#data")).scope();
            scope.$apply(function(){
                scope.addMessage(message);
            })

            // var divdata = $('#data');
            // var htmldata = "<ion-item class='notification' id='notification-"+ notificationID +"'>\""
            //                            + msg + 
            //                "\"<br> ~ " + fromName + "<br>" +
            //                "<button class='button-positive button button-clear'>Close</button>" +
            //                "<button class='button-calm button button-clear'>Reply</button>" +
            //                "</ion-item><br>";
            // divdata.html(divdata.html() + htmldata);

            if (isKnownContact(contacts, fromNumber)) {                    
                // Known Contacts
                if (shouldEmergency(msg)) {
                    // Emergency Override
                    if (acceptEmergency(contacts, fromNumber)) {
                        // alert("Known Contact with emergency permission, emergency found.");
                        scheduleAlert(msg, "Emergency", fromName);
                    } else {
                        // alert("Known Contact without emergency permission, emergency found.");
                    }
                } else {
                    if (shouldAlert(msg)) {
                        // Alert Override
                        if (acceptAlerts(contacts, fromNumber)) {
                            // alert("Known Contact with alert permission, alert found.");
                            scheduleAlert(msg, "Alert", fromName);
                        } else {
                            // alert("Known Contact without alert permission, alert found.");
                        }
                    } else {
                        // Silent
                        if (shouldSilent(msg)) {
                            if (acceptSilent(contacts, fromNumber)) {
                                // alert("Known Contact with silent permission, silent found.");
                                scheduleSilent(msg, "Silent", fromName);
                            } else {
                                // alert("Known Contact without silent permission, silent found.");
                            }
                        }
                    }
                }

                
            } else {
                // Unknown Contacts
                if (shouldAlert(msg)) {
                    if (default_notify) {
                        // alert("Unknown Contact, default accept emojis, alert found.");
                        scheduleAlert(msg, "Alert", fromNumber);
                    } else {
                        // alert("Unknown Contact, default reject emojis, alert found.");
                        scheduleSilent(msg, "Silent", fromNumber);
                    }
                }

                if (shouldSilent(msg)) {
                    if (default_notify) {
                        // alert("Unknown Contact, default accept emojis, silent found.");
                    } else {
                        // alert("Unknown Contact, default reject emojis, silent found.");
                    }
                }
                
            }
        }

        function initApp() {
            if (! SMS ) { alert( 'SMS plugin not ready' ); return; }
            
            // SMS Arrived
            document.addEventListener('onSMSArrive', function(e){
                var data = e.data;
                
                smsList.push( data );
                
                updateStatus('SMS arrived, count: ' + smsList.length );
                
                schmeeNotifications(data);
            });

            if (SMS) {
                toggleWatch();
                // toggleIntercept();
            }

            // Set location on notification click
            document.addEventListener('deviceready', function(){
                cordova.plugins.notification.local.onclick = function (notification) {
                    location.href="index.html";
                };
            }, false);

            // Background Mode
            document.addEventListener('deviceready', function () {
                cordova.plugins.backgroundMode.setDefaults({ text:'Watching incoming SMS.'});

                cordova.plugins.backgroundMode.enable();

                cordova.plugins.backgroundMode.onactivate = function () {
                    setTimeout(function () {
                        cordova.plugins.backgroundMode.configure({
                            text:'Watching for incoming SMS....'
                        });
                    }, 5000);
                }
            }, false);
        }
        
        function update( id, str ) {
            $('div#' + id).html( str );
        }
        function updateStatus( str ) {
            $('div#status').html( str );
        }
        function updateData( str ) {
            $('#data').html( str );
        }
        
        function sendSMS() {
            var sendto = $('input#smsTo').val().trim();
            var textmsg = $('textarea#smsBody').val();
            if(sendto.indexOf(";") >=0) {
                sendto = sendto.split(";");
                for(i in sendto) {
                    sendto[i] = sendto[i].trim();
                }
            }
            if(SMS) SMS.sendSMS(sendto, textmsg, function(){}, function(str){alert(str);});
        }

        function listSMS() {
            updateData('');
            
            if(SMS) SMS.listSMS({}, function(data){
                updateStatus('sms listed as json array');
                
                var html = "";
                if(Array.isArray(data)) {
                    for(var i in data) {
                        var sms = data[i];
                        html += sms.address + ": " + sms.body + "<br/>";
                    }
                }
                updateData( html );
                
            }, function(err){
                updateStatus('error list sms: ' + err);
            });
        }

        function deleteLastSMS() {
            updateData('');

            if(smsList.length == 0) {
                updateStatus( 'no sms id to delete' );
                return;
            }
            
            var sms = smsList.pop();
            
            if(SMS) SMS.deleteSMS({
                _id : sms["_id"]
            }, function( n ){
                updateStatus( n + ' sms messages deleted' );
            }, function(err){
                updateStatus('error delete sms: ' + err);
            });
        }

        function restoreAllSMS() {
            updateData('');
            
            if(SMS) SMS.restoreSMS(smsList, function( n ){
                smsList.length = 0;
                updateStatus(n + ' sms messages restored');
                
            }, function(err){
                updateStatus('error restore sms: ' + err);
            });
        }

        function startWatch() {
            if(SMS) SMS.startWatch(function(){
                $('#watchBtn').html('Stop Watching SMS');
            }, function(){
                updateStatus('failed to start watching');
            });
        }

        function stopWatch() {
            if(SMS) SMS.stopWatch(function(){
                $('#watchBtn').html('Start Watching SMS');
            }, function(){
                updateStatus('failed to stop watching');
            });
        }

        function toggleWatch() {
            watching = ! watching;

            if (watching) {
                startWatch();
            } else {
                stopWatch();
            }
        }
        
        function toggleIntercept() {
            interceptEnabled = ! interceptEnabled;
            
            if(interceptEnabled) {
                smsList.length = 0;
            }
            
            if(SMS) SMS.enableIntercept(interceptEnabled, function(){}, function(){});
        }

        function toggleDefaultNotify(){
            default_notify = ! default_notify;
        }
    </script>
</body>
</html>
